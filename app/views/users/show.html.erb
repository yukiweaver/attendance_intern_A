<% provide(:title, @user.name) %>
<% require "time" %>
<div class="row">
  <!-- 勤怠表示画面　一番上のテーブル -->
  <table class="table table-bordered table-striped table-condensed">
    <thead>
      <tr>
        <th colspan="1">
          <%= link_to "◀", user_path(params:{current_day: @last_month}), class: "btn btn-sm btn-primary" %> 
          <%= @current_day.year %>年 <%= @current_day.month %>月 時間管理表 
          <%= link_to "▶", user_path(params:{current_day: @next_month}), class: "btn btn-sm btn-primary" %>
        </th>
        <th>
          指定勤務開始時間 <%= basic_info_edit(@user.designate_work_time) %><br> <%# 勤怠B：basic_info_edit UsersHelperで定義 %>
          指定勤務終了時間 <%= basic_info_edit(@user.designate_end_time) %>
        </th>
        <th colspan="3">基本時間 <%= basic_info_edit(@user.basic_work_time) %></th>
        <th>初日 <%= @first_day.strftime("%m/%d") %></th>
      </tr>
      
      <tr>
        <th>所属 <%= @user.belong %></th>
        <th>氏名 <%= @user.name %></th>
        <th>コード</th>
        <th><%= @user.number %></th>
        <th>出勤日数
          <% if @attendance_count != nil %>
          <%= @attendance_count %>日
          <% else %>
          0日
          <% end %>
        </th>
        <th>締め <%= @last_day.strftime("%m/%d") %></th>
      </tr>
    </thead>
  </table>
  <% if current_user.superior? %>
    <p>
      【所属長承認申請のお知らせ】
      <% if @application_superior1 != nil && current_user.id == 2 %>
        <%= link_to "#{@application_superior1_count}件の通知があります", "#" %>
      <% elsif @application_superior2 != nil && current_user.id == 3 %>
        <%= link_to "#{@application_superior2_count}件の通知があります", "#" %>
      <% end %>
    </p>
    <p>
      【勤怠変更申請のお知らせ】
      <% if @attendance_superior1 != nil && current_user.id == 2 %>
        <%= link_to "#{@superior1_count}件の通知があります", "#" %>
      <% elsif @attendance_superior2 != nil && current_user.id == 3 %>
        <%= link_to "#{@superior2_count}件の通知があります", "#" %>
      <% end %>
    </p>
    <p>
      【残業申請のお知らせ】
      <% if @overtime_superior1 != nil && current_user.id == 2 %>
        <%= link_to "#{@overtime_superior1_count}件の通知があります", "#" %>
      <% elsif @overtime_superior2 != nil && current_user.id == 3 %>
        <%= link_to "#{@overtime_superior2_count}件の通知があります", "#" %>
      <% end %>
    </p>
  <% end %>
  <!-- 勤怠表示画面　勤怠編集ボタン -->
  <%= link_to "勤怠を編集", attendance_edit_path(params:{current_day: @current_day}), class: "btn btn-primary" %>
  <%= link_to "CSV出力", user_path(format: :csv, params:{current_day: @current_day}), class: "btn btn-primary" %><br>
  <%= link_to "勤怠修正ログ（承認済み）", "#", class: "btn btn-primary" %>
  
  <!-- 勤怠表示画面　下のメインのテーブル -->
  <table class="table table-bordered table-striped table-condensed">
    <thead>
      <tr>
        <th rowspan="2">残業申請</th>
        <th rowspan="2">日付</th>
        <th rowspan="2">曜日</th>
        <th colspan="3">出社</th>
        <th colspan="3">退社</th>
        <th rowspan="2">在社時間</th>
        <th rowspan="2">備考</th>
        <th colspan="2">終了予定時間</th>
        <th rowspan="2">時間外時間</th>
        <th rowspan="2">業務処理内容</th>
        <th rowspan="2">指示者確認</th>
      </tr>
      
      <tr>
        <th>時</th>
        <th>分</th>
        <th></th>
        <th>時</th>
        <th>分</th>
        <th></th>
        <th>時</th>
        <th>分</th>
      </tr>
    </thead>
    <!-- 以下日付や曜日などデータ部分 -->
    <tbody>
      <!--<div id="product-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"></div>-->
      <% @date.each do |date| %>  <!-- 月初から月末までの繰り返しを変数dateに格納  -->
      <%# binding.pry %>
      <tr>
        <!-- 第一項：残業申請 -->
        <td class="modal-open"><a href="#<%= date.attendance_day.day %>" class="btn btn-primary">残業申請</a></td>
        <!-- 第二項：日付 -->
        <td><%= date.attendance_day.month %>/<%= date.attendance_day.day %></td>  <!-- 変数dateから月と日を取得 -->
        <!-- 第三項：曜日 -->
        <td><%= @week[date.attendance_day.wday] %></td>  <!-- wdayメソッドは、その日の曜日を数値で戻す。(日曜が0) -->
        <!-- 第四項：出社（hours) -->
        <td><%= date.beginning_time.hour if date.beginning_time != nil %></td>
        <!-- 第五項：出社（minitue）-->
        <td><%= date.beginning_time.min if date.beginning_time != nil %></td>
        <!-- 第六項：出社ボタン -->
        <td>
          <% if date.beginning_time.nil? && date.leaving_time.nil? && date.attendance_day == Date.today %>
            <%= button_to "出社", beginning_time_path, class: "btn btn-primary" %>
          <% end %>
        </td>
        <!-- 第七項：退社（hours） -->
        <td><%= date.leaving_time.hour if date.leaving_time != nil %></td>
        <!-- 第八項：退社（minitues） -->
        <td><%= date.leaving_time.min if date.leaving_time != nil %></td>
        <!-- 第九項：退社ボタン -->
        <td>
          <% if date.leaving_time.nil? && date.beginning_time != nil && date.attendance_day == Date.today %>
            <%= button_to "退社", leaving_time_path, class: "btn btn-primary" %>
          <% end %>
        </td>
        <!-- 第十項：在社時間（翌日対応） -->
        <td>
          <% if date.beginning_time != nil && date.leaving_time != nil %>
            <% if date.next_day != true %>
              <%= company_time_edit(date.leaving_time - date.beginning_time) %>  <!-- 勤怠B：company_time_editはUsersHelperで定義 -->
            <% else %>
              <%= company_time_edit((date.leaving_time+86400.0) - date.beginning_time) %>
            <% end %>
          <% end %>
        </td>
        <!-- 第十一項：備考 -->
        <td><%= date.note %></td>
        <!-- 第十二項：終了予定時間（hours） -->
        <td><%= date.scheduled_end_time.hour if date.scheduled_end_time != nil %></td>
        <!-- 第十三項：終了予定時間（minites） -->
        <td><%= date.scheduled_end_time.min if date.scheduled_end_time != nil %></td>
        <!-- 第十四項：時間外時間（翌日対応） -->
        <td>
          <% if @user.designate_end_time && date.scheduled_end_time != nil %>
            <% if date.leaving_next_day != true %>
              <%= format("%.2f",(date.scheduled_end_time.hour.to_f + (date.scheduled_end_time.min.to_f / 60)) - (@user.designate_end_time.hour.to_f + (@user.designate_end_time.min.to_f / 60))) %>
            <% else %>
              <%= format("%.2f",(date.scheduled_end_time.hour.to_f + (date.scheduled_end_time.min.to_f / 60)) - (@user.designate_end_time.hour.to_f + (@user.designate_end_time.min.to_f / 60))+24.0) %>
            <% end %>
          <% end %>
        </td>
        <!-- 第十五項：業務処理内容 -->
        <td><%= date.business_outline if date.business_outline != nil %></td>
        <!-- 第十六項：指示者確認 -->
        <td>
          <% if date.instructor_test != nil %>
            残業申請：<%= date.instructor_test %>へ申請中</br>
          <% end %>
          <% if not date.attendance_test.blank? %>
            勤怠変更：<%= date.attendance_test %>へ申請中
          <% end %>
        </td>
      </tr>
      <%# binding.pry %>
      <% end %>
      <td colspan="2">
        総合勤務時間
        <% if @user.basic_work_time != nil && @attendance_count != nil %>
          <%= number_with_precision basic_info_edit(@user.basic_work_time).to_f * @attendance_count.to_f, precision:2 %>
        <% else @attendance_count == nil %>
          0.00
        <% end %>
      </td>
      <td colspan="6"></td>
      <td></td>
      <td>
        在社時間の合計
        <% if @company_time != nil %>
          <%= total_company_edit(@total_company_time) %>
        <% else @company_time == nil %>
          0.00
        <% end %>
      </td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td></td>
      <td>
        <% if @request_user == nil %>
          勤怠申請：なし
        <% elsif @request_user.authorizer_user_test == "上長A" %>
          勤怠申請：<%= @request_user.authorizer_user_test %>に申請中
        <% elsif @request_user.authorizer_user_test == "上長B" %>
          勤怠申請：<%= @request_user.authorizer_user_test %>に申請中
        <% end %>
        <%= form_for(@application_user, url: attendance_month_update_path, method: :post) do |f| %>
          <%= f.hidden_field :year, :value => @current_day.year %>
          <%= f.hidden_field :month, :value => @current_day.month %>
          <%#= f.hidden_field :month_attendance, :value => @date %>
          <%= f.hidden_field :application_user_id, :value => @user.id %>
          <%= f.hidden_field :application_date, :value => @current_day %>
          <% if current_user.superior? %>
            <%= f.select :authorizer_user_test, [@superior], :include_blank => true %>
          <% else %>
            <%= f.select :authorizer_user_test, @superior, :include_blank => true %>
          <% end %>
          <%= f.submit "申請", class: "btn btn-primary" %>
        <% end %>
      </td>
    </tbody>
  </table>
  <!-- 一日分の残業申請フォーム（モーダルで表示） -->
  <div style="display:none">
    <% @date.each do |date| %>
      <div class ="white-popup mfp-with-anim mfp-hide" id="<%= date.attendance_day.day %>" style="background-color:white">
        <h3 align="center" style="padding-top:15px">残業申請</h3>
        <%= form_for(date, url: attendance_overtime_update_path, method: :post) do |f| %>
        <%= f.hidden_field :id, :value => date.id %> <!-- attendancesテーブルのidを渡す -->
        <%= f.hidden_field :user_id, :value => @user.id %>
        <%= f.hidden_field :current_day, :value => @currrent_day %>
          <table class="txt1 table table-bordered table-striped table-condensed">
            <thead>
              <tr>
                <th>日付</th>
                <th>曜日</th>
                <th>終了予定時間（必須）</th>
                <th>翌日</th>
                <th>業務処理内容</th>
                <th>指示者確認（必須）</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <!-- 日付 -->
                <td><%= date.attendance_day.month %>/<%= date.attendance_day.day %></td>
                <!-- 曜日 -->
                <td><%= @week[date.attendance_day.wday] %></td>
                <!-- 終了予定時間 -->
                <td><%= f.time_field :scheduled_end_time, class: 'form-control' %> </td>
                <!-- 翌日　チェックボックス -->
                <td><%= f.check_box :leaving_next_day, id: :leaving_next_day, :as => :boolean %></td>
                <!-- 業務処理内容 -->
                <td><%= f.text_field :business_outline, class: 'form-controll' %></td>
                <!-- 指示者確認 -->
                <td>
                  <% if current_user.superior? %>
                    <%= f.select :instructor_test, [@superior], :include_blank => true %>
                  <% else %>
                    <%= f.select :instructor_test, @superior, :include_blank => true %>
                  <% end %>
                </td>
              </tr>
            </tbody>
          </table>
          <%= f.submit "残業を申請する", class: "btn btn-sm btn-primary" %>
        <% end %>
      </div>
    <% end %>
  </div>
  
  <!-- 上長が残業申請を確認 モーダルで表示 -->
  <% @date.each do |d| %>
    <h3 align="center"><%= "#{@user.name}からの残業申請" %></h3>
      <table class="txt1 table table-bordered table-striped table-condensed">
        <thead>
          <tr>
            <th>日付</th>
            <th>曜日</th>
            <th>終了予定時間</th>
            <th>指定勤務終了時間</th>
            <th>業務処理内容</th>
            <th>指示者確認</th>
            <th>変更</th>
            <th>勤怠を確認</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <!-- 日付 -->
            <td><%= d.attendance_day.month %>/<%= d.attendance_day.day %></td>
            <!-- 曜日 -->
            <td><%= @week[d.attendance_day.wday] %></td>
            <!-- 終了予定時間 -->
            <td>
            <% if d.scheduled_end_time != nil %>
              <%= d.scheduled_end_time.hour %>:<%= d.scheduled_end_time.min %>
            <% end %>
            </td>
            <!-- 指定勤務終了時間 -->
            <td>
              <%#= d.designate_end_time unless d.designate_end_time != nil %>
            </td>
            <!-- 業務処理内容 -->
            <td><%= d.business_outline if d.business_outline != nil %></td>
            <!-- 指示者確認 -->
            <td><%= d.instructor_test if d.instructor_test != nil %></td>
            <!-- 変更 -->
            <td></td>
            <!-- 勤怠を確認 -->
            <td><%= link_to "確認", "#", class: "btn btn-primary" %></td>
          </tr>
        </tbody>
      </table>
  <% end %>
</div>

<script>
// 1日分の残業申請フォーム　モーダル表示
  $(".modal-open").magnificPopup({
  delegate: 'a'
  // removalDelay: 500,
  // callbacks:{
  //   beforeOpen: function() {
  //     this.st.mainClass = this.st.el.attr('data-effect');
  //   },
  // },
});
</script>

      